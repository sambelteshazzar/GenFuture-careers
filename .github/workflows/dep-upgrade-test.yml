name: Dep Upgrade Test (FastAPI/Starlette matrix)

on:
  push:
    branches: [ dev/frontend-tests ]
  pull_request:
    branches: [ main, dev/frontend-tests ]
  workflow_dispatch:

jobs:
  dep-upgrade-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11]
        fastapi: ["0.118.2", "0.118.3"]
        starlette: ["0.48.0", "0.49.1"]
    name: Python ${{ matrix.python-version }} - FastAPI ${{ matrix.fastapi }} / Starlette ${{ matrix.starlette }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies (matrix)
        env:
          FASTAPI_OVERRIDE: ${{ matrix.fastapi }}
          STARLETTE_OVERRIDE: ${{ matrix.starlette }}
        run: |
          python -m pip install --upgrade pip setuptools wheel
          mkdir -p tmp
          awk 'BEGIN{found_fastapi=0;found_starlette=0} \
            /fastapi==/ {print "fastapi==" ENVIRON["FASTAPI_OVERRIDE"]; found_fastapi=1; next} \
            /starlette==/ {print "starlette==" ENVIRON["STARLETTE_OVERRIDE"]; found_starlette=1; next} \
            {print} END{ if(!found_fastapi) print "fastapi==" ENVIRON["FASTAPI_OVERRIDE"]; if(!found_starlette) print "starlette==" ENVIRON["STARLETTE_OVERRIDE"] }' backend/requirements.txt > tmp/requirements-matrix.txt
          python -m pip install -r tmp/requirements-matrix.txt

      - name: Run backend tests
        working-directory: backend
        run: |
          python -m pytest -q

      - name: pip-audit
        run: |
          python -m pip install pip-audit
          python -m pip_audit --format=json > pip-audit.json || true
        continue-on-error: true

      - name: Upload pip-audit results
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-${{ matrix.fastapi }}-${{ matrix.starlette }}
          path: pip-audit.json
